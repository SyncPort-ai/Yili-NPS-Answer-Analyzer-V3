# 多智能体设计与实现说明书 (补充文档)

本文件为《NPS V3 报告设计说明书》的补充部分，专注于 **多智能体 (Multi-Agent) 的角色定义、输入输出、提示词、可信度判定与错误管理**，以及在 LangGraph 中的实现思路。

---

## 1. 总体原则

1. **分层架构**：
   - 底座层 (数据处理与可信度)
   - 分析层 (推荐者/中性者/贬损者、文本聚类、驱动因子、维度对比等)
   - 咨询层 (战略顾问、产品与体验顾问、市场与品牌顾问、风险与合规顾问、总结协调官)

2. **避免过度解读**：
   - 文本/原话类输出：可多一些，满足业务需求。
   - 商业/战略类输出：通常 1–3 条，且受可信度约束。

3. **可信度计算**：不仅考虑比例，还要结合有效样本总量。
   - 例：1000 份答卷，80% 有效 ≈ 高可信度；1000 份答卷，50% 有效 ≈ 中可信度。

4. **动态题目识别**：不能依赖固定的 Q2/Q3/Q4/Q5。需要通过 **题干语义识别** 来判断：
   - Q1 = 打分题 (推荐可能性)
   - Q2/Q3 = 负面相关 (不推荐原因，多选/填空)
   - Q4/Q5 = 正面相关 (推荐原因，多选/填空)
   - 如遇不确定 → 通过群体统计 (如“所有 9 分用户常见回答”) 进行反推。

5. **LangGraph 分阶段运行**：
   - 考虑上下文窗口限制，将多智能体分为若干批次执行，再由“汇总节点”合并。

---

## 2. 底座层智能体 (Foundation Agents)

### A0 数据预处理员
- **输入**：原始问卷 JSON
- **任务**：
  - 抽取题干、题型、顺序
  - 数值化 Q1 打分
  - 识别无效回答 (如“无”“不知道”)
- **输出**：标准化答卷对象、初步分类文本集 (推荐者/贬损者/全体)
- **错误判定**：缺少 Q1 → `INPUT_SCHEMA_ERROR`

### A1 NPS 计算员
- **输入**：Q1 打分
- **输出**：推荐者、中性者、贬损者占比，NPS 值
- **错误判定**：分布极端 (如 90% 以上集中单一分数) → `SKEWED_DISTRIBUTION_WARNING`

### A2 样本可信度审查员
- **输入**：样本量、有效率
- **输出**：可信度标签 (high/medium/low)，理由
- **规则**：
  - 有效样本 <30 → low
  - 30–99 → medium
  - ≥100 且有效率 ≥70% → high

### A3 数据质量监控员
- **输入**：全局答卷信息
- **输出**：数据完整性报告、缺口提示

---

## 3. 分析层智能体 (Analysis Agents)

### B1 推荐者洞察员
- **输入**：推荐者文本
- **输出**：推荐动因，1–4 条建议

### B2 中性者洞察员
- **输入**：中性者文本
- **输出**：转化杠杆点，1–3 条建议

### B3 贬损者洞察员
- **输入**：贬损者文本
- **输出**：痛点总结，1–3 条改进建议

### B4 文本聚类分析员
- **输入**：全体开放题文本
- **输出**：主题+情感，推荐/贬损者主题词云 (基于主题词，不是原词)
- **错误判定**：无效回答率过高 → `TEXT_QUALITY_WARNING`

### B5 驱动因子分析员
- **输入**：多选题 (Q2/Q4)
- **输出**：重要性 vs 满意度矩阵，优先级 (Critical/High/Medium/Low)

### B6 维度对比分析员
- **输入**：产品/地域/触点/人群标签
- **输出**：各维度 1–3 条洞察；缺数据 → “暂无数据”提示

### B7 趋势分析员
- **输入**：历史样本
- **输出**：同比/环比趋势
- **缺失数据**：输出“暂无历史趋势”

### B8 竞品对比分析员
- **输入**：行业/竞品数据
- **输出**：对标结果；无数据 → “暂无对标数据”

### B9 分析汇总协调员
- **输入**：B1–B8 输出
- **输出**：去重与加权排序的洞察列表

---

## 4. 咨询层智能体 (Consulting Agents)

### C1 战略顾问
- **输入**：整体 NPS + 驱动因子矩阵 + 维度对比
- **输出**：1–3 条长期战略建议
- **限制**：low 可信度时 → 仅输出“复盘/补数”提示

### C2 产品与体验顾问
- **输入**：推荐/贬损动因、驱动因子
- **输出**：1–4 条短期可执行建议

### C3 市场与品牌顾问
- **输入**：推荐者动因、品牌相关文本
- **输出**：1–3 条市场/品牌建议

### C4 风险与合规顾问
- **输入**：贬损者痛点、敏感 verbatim
- **输出**：1–3 条风险预警/缓解方案

### C5 总结协调官
- **输入**：C1–C4
- **输出**：执行摘要 (5–7 条)，含行动建议
- **额外任务**：自动补充“复盘建议”，如“建议扩大样本/补齐地域标签”

---

## 5. 提示词 (Prompts) 要点

- **全局约束**：
  - 不可过度解读小样本
  - 低可信度场景 → 不生成高优先级战略结论
  - 输出必须 JSON 化，结构字段齐全

- **B4 文本聚类示例**：
  ```
  任务：对输入文本进行主题与情感识别。若为乳品场景，则映射到{口感, 包装, 价格, 健康, 创新, 服务}；若为系统场景，则映射到{易用性, 界面, 性能, 功能, 服务}。不在列表的归类为“新兴话题”。
  输出：主题+情感分布、典型原话、主题词词云（按情感区分）。
  ```

- **C2 产品顾问示例**：
  ```
  任务：结合推荐/贬损动因与驱动矩阵，提出1–4条短期可执行动作，每条动作包含目标、责任方、时间窗口。
  若可信度=low，则建议先补充样本或试点验证。
  ```

---

## 6. LangGraph 执行策略

- **分批执行**：将 A 层、B 层、C 层拆分为独立子图，避免 token 溢出；最后由协调节点合并。  
- **执行顺序**：
  - A0 → A1 → A2 → A3  
  - B1–B8 并行 → B9 汇总  
  - C1–C4 并行 → C5 汇总  
- **错误与警告**：写入全局 `warnings/errors`，供 HTML 报告展示。

---

## 7. 可信度判定优化

不仅考虑比例，还结合有效样本总数：
- e.g. 1000 份样本，80% 有效 (800 份) → High  
- 1000 份样本，50% 有效 (500 份) → Medium  
- 50 份样本，40% 有效 (20 份) → Low

同时要求在报告中清晰标注：  
“⚠️ 当前结论基于 **{有效样本数}/{总样本数}**，请谨慎参考。”

---

## 8. 动态问卷处理

- 不能依赖 Q2/Q3/Q4/Q5 固定顺序。  
- 使用题干关键词 (如“不愿意推荐原因”/“愿意推荐原因”) 判断正负向。  
- 如个体答卷难以确认 → 通过**群体对比**反推 (例如：大多数 9 分用户回答的问题集合)。

---

## 9. 报告生成与交付

- 输出：JSON + 单文件 HTML  
- HTML 模板 (Tailwind) 包含：
  - 执行摘要 (C5 输出)
  - KPI 卡片 (NPS、样本量、可信度)
  - 驱动因子矩阵
  - 推荐者 vs 贬损者主题词云 (附解读)
  - 多维度占位卡片 (如缺失则提示)
  - “复盘建议”固定区

---

**作者：** 产品设计负责人 / NPS 工具专家  
**版本：** v0.1 (初稿，供内部评审)
