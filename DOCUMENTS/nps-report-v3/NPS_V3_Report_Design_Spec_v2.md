# zhege

**作者**：产品设计负责人 / NPS 工具专家
**版本**：v0.2 (二次修订版)
**日期**：2025-09-23

---

## 1. 背景与目标

### 1.1 背景

现有 V2 架构基于七智能体，能够输出基础的 NPS 报告【84†source】。但存在以下问题：

- 固定题号假设，无法适应问卷顺序变化。
- 忽略中性者，洞察不完整。
- 缺乏可信度分级，容易过度解读小样本。
- 缺少多维度/战略层的系统分析。

### 1.2 V3 目标

- 建立 **输入 → 多智能体分析 → 洞察合成 → 报告输出** 的端到端工作流【88†source】。
- 输出：结构化 JSON + 单文件 HTML（Tailwind 自包含）。
- **满足不同角色需求**：高管快速决策、一线团队看 verbatim、分析师可钻取。
- 引入 **可信度机制** 和 **复盘建议**，降低 AI 幻觉风险。
- 融合行业最佳实践与 AI 多智能体趋势，提升商业价值。

---

## 2. 报告受众与角色需求

### 2.1 内部角色

- **产品设计师/经理**：避免 over-design；强调交互清晰、HTML 单页自包含。
- **架构师/开发工程师**：要求 LangGraph 分批执行，避免 token 溢出；内部库优先，API 最小暴露。
- **测试工程师**：需要严格的错误分类和测试矩阵（输入、样本、趋势、对标）。

### 2.2 伊利方角色

- **客户经理**：确保报告能直观服务于伊利管理层；执行摘要 ≤1 页。
- **管理层 (60–80%)**：关注执行摘要、短期/长期建议。
- **一线团队 (产品/运营/市场/客服)**：关注 verbatim、词云、关键驱动因子。

### 2.3 行业洞察

- **乳制品调研**：聚焦口感、健康/安全、包装、价格、创新。
- **系统/小程序调研**：聚焦易用性、界面、性能、功能、服务。

---

## 3. 输入与数据处理

### 3.1 输入格式

- 根对象：`yili_survey_data_input` (兼容 V2)【84†source】
- 字段：Q1 打分、Q2/Q4 多选题、Q3/Q5 开放题、元信息 (产品/地域/渠道/人群)。

### 3.2 动态题序识别

- 不依赖固定 Q2/Q3/Q4/Q5。
- 基于题干关键词识别 (如“推荐原因”“不推荐原因”)【104†source】。
- 若个体难以确认 → 群体对比推断 (如“9 分用户常见回答模式”)。

### 3.3 数据清洗

- 数值化打分 ("5分" → 5)。
- 标注无效回答 ("无"/"不知道")。
- 样本量与有效率统计。

### 3.4 可信度分级 (更新)

- **Low**：有效样本 <30，或有效率 <30%。
- **Medium**：30–99，或 100–149 且有效率 <70%。
- **High**：≥150 且有效率 ≥70%。
- **Medium-High (特例)**：当样本 100±20 且有效率 ≥60%。
  - 解释：伊利常规样本量在 100 左右，应给予“可用但需谨慎”的标签，而不是简单判为 low。

---

## 4. 多智能体架构

### 4.1 分层架构

1. **底座层 (Foundation)**：数据预处理、NPS 计算、可信度校验、质量监控。
2. **分析层 (Analysis)**：推荐者/中性者/贬损者、文本聚类、驱动因子、维度对比、趋势、竞品。
3. **咨询层 (Consulting)**：战略顾问、产品与体验顾问、市场品牌顾问、风险合规顾问、总结协调官。

### 4.2 智能体分工

详见补充文档《NPS V3 多智能体设计与实现说明书》【104†source】。

- 文本类输出可较多，满足一线团队需求。
- 商业/战略类输出 ≤3 条，避免过度解读。
- C5 总结协调官统一收敛，执行摘要 ≤7 条。

### 4.3 LangGraph 策略

- 分批执行：A/B/C 层分别运行，再汇总，避免 token 溢出。
- 错误与警告写入全局，供 HTML 报告展示。

---

## 5. 报告结构 (HTML + JSON)

### 5.1 HTML 模板 (Tailwind，自包含)【89†source】

- **封面**：标题、生成时间、样本量、可信度。
- **执行摘要**：精选 5–7 条战略/执行建议 (含短期/长期)。
- **核心指标**：NPS 值 + 分布 (推荐/中性/贬损者)。
- **驱动因子矩阵**：重要性 vs 满意度 (Critical/High/Medium/Low)。
- **开放题分析**：主题聚类 + 情感分布；推荐者 vs 贬损者词云 (基于主题词)。
- **多维度分析**：产品、地域、触点、人群；缺数据则提示“暂无”。
- **战略洞察**：C1–C4 输出。
- **复盘建议**：如“扩大样本/增加地域/丰富触点”。
- **附录**：数据质量说明、方法论。

### 5.2 JSON 输出结构

参考 V1 初稿【103†source】，新增 `confidence_sublevel` 字段用于标记 Medium-High 情况。

---

## 6. 错误与风险管理

- **INPUT_SCHEMA_ERROR**：缺少必填字段。
- **INSUFFICIENT_SAMPLE_WARNING**：样本不足。
- **SKEWED_DISTRIBUTION_WARNING**：分布极端 (90%+ 集中)。
- **TEXT_QUALITY_WARNING**：开放题无效率高。
- **DIMENSION_DATA_GAP**：产品/地域/触点/人群缺失。
- **BENCHMARK_MISSING**：行业对标缺失。

测试工程师需设计覆盖上述场景的 **单元/集成/Smoke Test**。

---

## 7. 工程实现与交付

### 7.1 技术栈

- Python + FastAPI (API V3 + Portal)
- Tailwind (HTML 单页报告)
- LangGraph (多智能体编排)
- 内部库优先，API 最小暴露【87†source】。

### 7.2 API 定义

`POST /nps_report_v3`

- 输入：V2 兼容 JSON【84†source】
- 输出：JSON + HTML(base64)

### 7.3 交付节奏

- **MVP (2–3 周)**：NPS计算、推荐/中性/贬损者、文本聚类、执行摘要、可信度提示。
- **增强 (后续)**：驱动因子矩阵、维度对比、战略顾问层、趋势/对标。

---

## 8. 推荐设计工作流

1. **文档化**：完成《报告设计说明书》+《多智能体补充文档》。
2. **原型验证**：用小样本生成 demo HTML+JSON，收集反馈。
3. **工程交付**：开发 `schemas.py`、`graph.py`、`api_v3.py`、`report_template.html`。
4. **测试与迭代**：覆盖低样本、极端分布、维度缺失等。
5. **业务复盘**：结合伊利内部反馈，优化权重与 Prompts。

---

## 9. 附录 (含内容摘要)

### 9.1 《NPS V3 多智能体设计与实现说明书》

定义 3 层智能体 (Foundation/Analysis/Consulting)，说明输入输出、Prompts 样例、LangGraph 执行策略、可信度优化【104†source】。

### 9.2 《NPS 方法论回顾与 AI 扩展》

- NPS 标准方法：9–10 推荐者，7–8 中性者，0–6 贬损者。
- AI 扩展：开放题聚类、情感标注、多维度标签、趋势/对标。
- 复盘建议机制：在样本不足时提醒“补齐地域/渠道/触点”。

### 9.3 《伊利智能 NPS 平台设计》

- 接入层：FastAPI V2/V3 路由。
- 工作流层：七智能体 (V2) vs 扩展多智能体 (V3)。
- 知识管理：标签体系、业务规则管理、反馈迭代。
- 呈现层：HTML 报告、未来 PDF 导出【88†source】。

### 9.4 《V2 API 文档》

- 兼容性说明。
- 输入/输出 JSON 定义。
- 保持 legacy 系统平滑迁移【84†source】。

### 9.5 《开放文本分析接口文档》

- 输入参数：questionId、question、emotionalType、taskType、wordInfos【85†source】。
- 输出字段：aspect、opinion、topic、无效样本识别。
- 用于生成主题聚类、情感标签、无效回答过滤。

### 9.6 《Demo HTML 报告》

- 展示执行摘要、NPS 构成、关键主题、战略洞察【89†source】。
- 提供直观模板，便于比对 V3 新版 HTML 报告。

---

**结论**：
V3 报告在第二版设计中，强化了 **可信度机制 (引入 Medium-High)**、**多角色需求平衡**、**附录内容补充**，并吸纳了 **产品/工程/测试/客户/行业** 多方视角。
它既保证高管“一眼看懂”，也满足一线团队对 verbatim 和驱动因子的需求，为伊利搭建出一个 **稳健、可扩展、商业价值显著** 的智能调研平台。
