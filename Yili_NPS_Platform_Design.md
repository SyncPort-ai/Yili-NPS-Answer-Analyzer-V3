# 伊利智能 NPS 调研洞察研究平台 – 实施设计

## 1. 背景与目标
- 构建一套贯穿“调研数据采集 → 多智能体分析 → 知识沉淀 → 洞察输出”的端到端平台。
- 保持现有 V2 API 稳定，对外提供可靠的 JSON/HTML 报告服务，同时在独立 V3 架构中快速迭代增强能力。
- 支撑伊利业务线的 KPI 复盘、危机预警、产品创新验证与跨团队协同。

## 2. 范围界定
- **包含**：问卷数据接入、NPS 指标计算、开放文本聚类、竞争情报/市场趋势生成、知识库管理、报告编排、API 与前端展示、运维监控。
- **不包含**：问卷发放系统改造、外部 CRM/BI 系统集成（仅预留接口）、线下数据录入流程。

## 3. 用户画像与使用场景
- 品牌/品类负责人：查看月度/季度 NPS 报告、制定行动计划。
- 客服与体验团队：接收贬损者预警、跟进闭环结果。
- 数据分析师：管理模型配置、迭代知识库标签与业务规则。
- 管理层：在仪表盘查看整体趋势、区域/渠道对比、AI 摘要。

## 4. 平台总体架构
1. **接入层**：FastAPI 应用 (`api.py`) 暴露 `/nps-report-v2`、`/api/v2/...` 等稳定接口；`api_v3.py` 注册独立路由 `/nps-report-v3`、`/api/v3/...`。
2. **工作流层**：
   - `nps_report_v2/`：七智能体工作流（数据验收、NPS 算法、文本聚类、对外报告）。
   - `nps_report_v3/`：扩展版工作流（双通道输入、质量评估、增强报告）。
3. **知识与配置层**：`PersistentKnowledgeManager`、`AuxiliaryDataManager` 负责业务规则、标签体系、辅助数据文件（参考 `modify_knowledge_example.py`）。
4. **分析服务层**：`opening_question_analysis.py`、`cluster.py`、`llm.py`、`prompts.py` 等实现核心算法，统一封装到工作流。
5. **呈现层**：HTML 模板 (`templates/`)、静态资源 (`static/`) 构建 NPS 报告和 Web Dashboard；计划引入 PDF 导出。
6. **存储与日志**：所有输出写入 `outputs/`，日志到 `logs/app.log`；未来接入对象存储/ELK。

## 5. 数据与流程设计
- **输入格式**：
  - 传统结构：`survey_responses[{score, comment, region, ...}]`。
  - 扁平中文格式：`yili_survey_data_input`（统一字段命名、题目映射）。
- **处理流程**：
  1. 请求校验（Pydantic 模型 + 自定义校验）。
  2. 输入模式识别与清洗。
  3. 多智能体执行（评分段划分、主题聚类、情感分类、市场/竞品补充）。
  4. 知识库强化（根据业务规则打分、补充标签、写入反馈）。
  5. 报告合成（KPI 卡片、主题洞察、行动建议、风险提示）。
  6. 输出持久化（JSON/HTML）并返回 API 响应。
- **扩展**：支持设置 `response_mode=demo` 进入可重复模式；引入任务队列保证大批量处理。

## 6. 核心模块说明
- **API 网关**：隔离 V2/V3 路由，封装异常处理、熔断策略；未来通过网关进行鉴权。
- **Agent 工作流**：七智能体包括数据专家、体验评估、竞争情报、策略顾问等角色，通过共享内存对象交换结果并归并。
- **知识管理**：
  - 手工/程序化方式更新业务规则（评分阈值、质检指标）。
  - 建立标签库（品类、场景、渠道、情绪），提升聚类质量。
  - 集成用户反馈以实现持续学习。
- **报告生成器**：按设计文档中的模板输出多语言内容，支持定制图表、行动追踪表，后续引入版本对比。
- **监控告警**：记录处理时间、AI 调用次数、异常堆栈；计划接入 Prometheus/Grafana。

## 7. 安全与合规
- 加强 `.env` 管理，敏感 Key 由密钥服务统一注入。
- 对外接口加入 IP 白名单/Token（下一阶段）。
- PII 字段（客户 ID、联系方式）在存储前脱敏；限定日志级别避免泄露。
- 对第三方模型调用做好失败重试与费用监控。

## 8. 交付与迭代计划
- Phase 0：需求确认、数据口径对齐、环境准备。
- Phase 1：V3 API MVP（继承 V2 输入/输出，验证增强功能），知识库管理工具上线。
- Phase 2：前端仪表盘 + 定时任务、PDF 导出、通知集成。
- Phase 3：预测模型、问卷自适应、跨系统对接。

## 9. 测试与运维策略
- 单元测试覆盖数据清洗、评分、聚类、知识更新。
- Smoke 测试：`smoke_test_v2.py`、`smoke_test_v3.py` 保障版本隔离。
- 集成测试：模拟典型样本、中文扁平格式、极端场景。
- 监控：记录响应时间、错误率；设置结果校验任务（NPS 区间、样本量）。

## 10. 风险与缓解
- **外部 API 依赖不稳定**：准备本地/模型缓存，设置降级策略。
- **数据质量参差**：强化输入校验、提供质检报告、引入自动补齐提示。
- **知识库管理复杂**：开发 GUI/CLI 辅助工具，增加版本回滚。
- **多团队协作**：采用任务看板，定期评审需求变更；文档化接口协议。

## 11. 成功指标
- 生成完整报告耗时 ≤ 2 分钟；多批量请求成功率 ≥ 99%。
- 推荐者识别准确率 ≥ 95%，文本主题召回率 ≥ 80%。
- AI 报告审核通过率 ≥ 85%，业务团队满意度 ≥ 90%。
- 月度活跃使用团队 ≥ 4 个，知识库更新频率 ≥ 每周一次。

## 12. 后续工作
- 补充详细数据字典、字段映射、模型参数表。
- 与伊利 IT 确定部署方式（云/本地）、网络策略。
- 制定上线手册与培训资料，支持业务侧自助操作。
